<% require 'yaml' -%>
# The testing matrix considers ruby/puppet versions supported by SIMP and PE:
#
# https://puppet.com/docs/pe/2018.1/component_versions_in_recent_pe_releases.html
# https://puppet.com/misc/puppet-enterprise-lifecycle
# ------------------------------------------------------------------------------
#  release    pup   ruby      eol
# SIMP6.0.0   4.8   2.1.9  TBD
# PE 2016.5   4.10  2.1.9  2018-12-31
# PE 2017.3   5.3   2.4.4  2018-12-31
# PE 2018.1   5.5   2.4.4  2020-05  (LTS)
---
stages:
  - validation
  - unit
  - acceptance

<% @configs['before_scripts'].to_yaml %>

<% @configs['puppet_versions'].each do |version,data| -%>
<% version -%>-validation:
  stage: validation
  tags:
    - docker
  image: ruby:<% data['ruby_version'].split('.')[0..1].join('.') -%>
  variables:
    PUPPET_VERSION: "<% data['puppet_version'] -%>"
  <% @config['cache'] -%>
  <% @config['before_script'] -%>
  script:
  <% data['validation_checks'].map(&:split).flatten.each do |check| -%>
  - bundle exec <% check -%>
  <% end -%>
<% version -%>-unit:
  stage: unit
  tags:
    - docker
  image: ruby:<% data['ruby_version'].split('.')[0..1].join('.') -%>
  variables:
    PUPPET_VERSION: "<% data['puppet_version'] -%>"
  <% @config['cache'] -%>
  <% @config['before_script'] -%>
  script:
  <% data['spec_checks'].map(&:split).flatten.each do |check| -%>
  - bundle exec <% check -%>
  <% end -%>
<% end -%>


# Acceptance tests
# ==============================================================================
base_apps:
  stage: acceptance
  tags:
    - beaker
  <<: *cache_bundler
  <<: *setup_bundler_env
  variables:
    PUPPET_VERSION: '~> 4.10.0'
  script:
    - bundle exec rake beaker:suites[base_apps]

default:
  stage: acceptance
  tags:
    - beaker
  <<: *cache_bundler
  <<: *setup_bundler_env
  variables:
    PUPPET_VERSION: '~> 4.10.0'
  script:
    - bundle exec rake beaker:suites[default]

default-fips:
  stage: acceptance
  tags:
    - beaker
  <<: *cache_bundler
  <<: *setup_bundler_env
  variables:
    PUPPET_VERSION: '~> 4.10.0'
    BEAKER_fips: 'yes'
  script:
    - bundle exec rake beaker:suites[default]

default-puppet5:
  stage: acceptance
  tags:
    - beaker
  <<: *cache_bundler
  <<: *setup_bundler_env
  variables:
    PUPPET_VERSION: '~> 5.3.0'
  script:
    - bundle exec rake beaker:suites[default,puppet5]
  allow_failure: true

no_simp_server:
  stage: acceptance
  tags:
    - beaker
  <<: *cache_bundler
  <<: *setup_bundler_env
  variables:
    PUPPET_VERSION: '~> 4.10.0'
  script:
    - bundle exec rake beaker:suites[no_simp_server]

netconsole:
  stage: acceptance
  tags:
    - beaker
  <<: *cache_bundler
  <<: *setup_bundler_env
  variables:
    PUPPET_VERSION: '~> 4.10.0'
  script:
    - bundle exec rake beaker:suites[netconsole]

one_shot_scenario:
  stage: acceptance
  tags:
    - beaker
  <<: *cache_bundler
  <<: *setup_bundler_env
  variables:
    PUPPET_VERSION: '~> 4.10.0'
  script:
    - bundle exec rake beaker:suites[scenario_one_shot]

poss_scenario:
  stage: acceptance
  tags:
    - beaker
  <<: *cache_bundler
  <<: *setup_bundler_env
  variables:
    PUPPET_VERSION: '~> 4.10.0'
  script:
    - bundle exec rake beaker:suites[scenario_poss]

remote_access_scenario:
  stage: acceptance
  tags:
    - beaker
  <<: *cache_bundler
  <<: *setup_bundler_env
  variables:
    PUPPET_VERSION: '~> 4.10.0'
  script:
    - bundle exec rake beaker:suites[scenario_remote_access]
